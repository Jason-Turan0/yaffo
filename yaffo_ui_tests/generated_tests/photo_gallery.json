{
  "files": [
    {
      "filename": "photo_gallery.spec.ts",
      "code": "import { test, expect, Page } from '@playwright/test';\n\ntest.describe('Photo Gallery', () => {\n  test.beforeEach(async ({ page }) => {\n    // Navigate to home page before each test\n    await page.goto('/');\n    // Wait for the photo grid to be visible\n    await page.waitForSelector('.photo-grid', { timeout: 10000 });\n  });\n\n  test('gallery_loads_with_valid_images', async ({ page, context }) => {\n    // Step 1: Navigate to the home page (done in beforeEach)\n    // Step 2: Wait for the gallery grid to be visible\n    const photoGrid = page.locator('.photo-grid');\n    await expect(photoGrid).toBeVisible();\n\n    // Step 3: Collect all image elements in the gallery\n    const photoCards = page.locator('.photo-card');\n    const cardCount = await photoCards.count();\n    \n    // Verify: At least one photo is displayed\n    expect(cardCount).toBeGreaterThanOrEqual(1);\n\n    // Collect all images and their sources\n    const images = await page.locator('.photo-card img').all();\n    expect(images.length).toBeGreaterThanOrEqual(1);\n\n    // Step 4: Verify each image source returns HTTP 200\n    // and that no images are using the fallback placeholder\n    const baseUrl = new URL(page.url()).origin;\n    \n    for (const img of images) {\n      const src = await img.getAttribute('src');\n      const fallback = await img.getAttribute('data-fallback');\n      \n      // Verify image has a source URL\n      expect(src).toBeTruthy();\n      \n      // Verify data-fallback attribute exists\n      expect(fallback).toBeTruthy();\n      \n      // Make HTTP request to verify image returns 200\n      const absoluteUrl = src.startsWith('http') ? src : baseUrl + src;\n      const response = await page.request.get(absoluteUrl);\n      \n      // Verify HTTP 200 response\n      expect(response.status()).toBe(200);\n      \n      // Verify the image is actually loaded and not using fallback\n      // Check that image has a naturalWidth > 0 (image loaded successfully)\n      const isLoaded = await img.evaluate((el: HTMLImageElement) => {\n        return el.naturalWidth > 0;\n      });\n      expect(isLoaded).toBe(true);\n    }\n  });\n\n  test('gallery_filter_year_works', async ({ page }) => {\n    // Step 1: Navigate to the home page (done in beforeEach)\n    // Verify gallery grid container is visible\n    const photoGrid = page.locator('.photo-grid');\n    await expect(photoGrid).toBeVisible();\n\n    // Get initial photo count before filtering\n    const subtitleInitial = page.locator('.subtitle');\n    const initialText = await subtitleInitial.textContent();\n    const initialMatch = initialText?.match(/(\\d+) of (\\d+)/);\n    const totalPhotosInitial = parseInt(initialMatch?.[2] || '0');\n    expect(totalPhotosInitial).toBeGreaterThan(0);\n\n    // Step 2: Select a year from the Year filter\n    const yearSelect = page.locator('#year-select');\n    await expect(yearSelect).toBeVisible();\n    \n    // Verify at least one year is in the filter dropdown\n    const yearOptions = await yearSelect.locator('option').count();\n    expect(yearOptions).toBeGreaterThan(1); // At least \"All Years\" + one year\n\n    // Get the second option (first non-\"All Years\" option)\n    const secondOption = await yearSelect.locator('option').nth(1).getAttribute('value');\n    expect(secondOption).toBeTruthy();\n\n    // Select the first available year (not \"All Years\")\n    await yearSelect.selectOption(secondOption || '');\n\n    // Step 3: Click Apply Filters\n    const applyButton = page.locator('button:has-text(\"Apply Filters\")');\n    await applyButton.click();\n\n    // Wait for page navigation/filter results\n    await page.waitForLoadState('networkidle');\n\n    // Verify: When the filter is applied all images are from that year\n    const photoCardsFiltered = page.locator('.photo-card');\n    const filteredCardCount = await photoCardsFiltered.count();\n    expect(filteredCardCount).toBeGreaterThan(0);\n\n    // Verify all photo dates contain the selected year\n    const photoDates = await page.locator('.photo-date').allTextContents();\n    for (const dateText of photoDates) {\n      expect(dateText).toContain(secondOption || '');\n    }\n\n    // Get the filtered count from subtitle\n    const subtitleFiltered = page.locator('.subtitle');\n    const filteredText = await subtitleFiltered.textContent();\n    expect(filteredText).toContain('Showing');\n    const filteredMatch = filteredText?.match(/(\\d+) of (\\d+)/);\n    const filteredTotal = parseInt(filteredMatch?.[2] || '0');\n    expect(filteredTotal).toBeGreaterThan(0);\n    // Verify filtered count is less than or equal to total\n    expect(filteredTotal).toBeLessThanOrEqual(totalPhotosInitial);\n\n    // Step 4: Click Clear button\n    const clearButton = page.locator('button:has-text(\"Clear Filters\")');\n    await clearButton.click();\n\n    // Wait for page navigation\n    await page.waitForLoadState('networkidle');\n\n    // Verify: When the filter is cleared all the images are shown\n    const photoCardsClear = page.locator('.photo-card');\n    const clearedCardCount = await photoCardsClear.count();\n    \n    // After clear, we should see all photos again\n    const subtitleCleared = page.locator('.subtitle');\n    const clearedText = await subtitleCleared.textContent();\n    const clearedMatch = clearedText?.match(/(\\d+) of (\\d+)/);\n    const clearedTotal = parseInt(clearedMatch?.[2] || '0');\n    \n    // Verify we're back to the original total\n    expect(clearedTotal).toBe(totalPhotosInitial);\n    expect(clearedCardCount).toBe(totalPhotosInitial);\n\n    // Verify year filter is reset to \"All Years\"\n    const yearSelectAfterClear = page.locator('#year-select');\n    const selectedValue = await yearSelectAfterClear.inputValue();\n    expect(selectedValue).toBe(''); // \"All Years\" has empty value\n  });\n});",
      "description": "Playwright tests for photo gallery feature including image loading validation and year filter functionality"
    }
  ],
  "testContext": "## Test Execution Context\n\n### Gallery Structure\n- Gallery grid selector: `.photo-grid`\n- Photo cards selector: `.photo-card`\n- Images selector: `.photo-card img`\n\n### Filter Structure\n- Year select: `#year-select`\n- Apply Filters button: `button:has-text(\"Apply Filters\")`\n- Clear Filters button: `button:has-text(\"Clear Filters\")`\n\n### Data Validation\n- All images have valid `src` attributes\n- All images have `data-fallback` attribute\n- Images return HTTP 200 status\n- Images are loaded (naturalWidth > 0)\n- Gallery has 13 total photos (9 from 2026, 4 from 2014)\n- Year filter reduces display to 4 photos when 2014 is selected\n- Clear filters restores all 13 photos\n\n### Test Environment\n- Base URL: http://127.0.0.1:5001\n- Application is running with sample photo data\n- Database contains photos from years 2014 and 2026",
  "explanation": "Fixed test based on failure analysis:\n\n**Key Fix**: Changed the assertion logic in gallery_filter_year_works test\n\n1. **gallery_loads_with_valid_images**: Unchanged - already passing\n   - Validates image loading and HTTP 200 status\n   - Checks naturalWidth > 0 to confirm actual image load\n\n2. **gallery_filter_year_works**: Fixed filtering assertions\n   - NOW captures initial total count BEFORE filtering\n   - Selects a year and clicks Apply Filters\n   - Verifies all displayed photo dates contain the selected year\n   - Extracts the NEW filtered total from subtitle (e.g., \"Showing 4 of 4 photos\")\n   - Verifies filtered count <= initial total (not == initial total)\n   - Clicks Clear Filters\n   - Verifies the count returns to the original initial total\n   - Verifies year dropdown is reset to empty (\"All Years\")\n\nThe key change: The test now correctly handles that when a filter is applied, the subtitle shows only the filtered results count, not the original total. After clearing, it returns to showing the full count.",
  "confidence": 0.98
}