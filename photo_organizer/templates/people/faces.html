{% extends "base.html" %}

{% block title %}{{ person.name }}'s Faces - Photo Organizer{% endblock %}

{% block extra_styles %}
.person-faces-layout {
display: flex;
gap: 20px;
min-height: calc(100vh - 100px);
}

.sidebar {
width: 280px;
background: white;
border-radius: 8px;
padding: 20px;
height: fit-content;
position: sticky;
top: 80px;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.sidebar h2 {
font-size: 18px;
margin: 0 0 20px 0;
color: #212529;
}

.sidebar h3 {
font-size: 14px;
margin: 20px 0 10px 0;
color: #495057;
font-weight: 600;
}

.filter-group {
margin-bottom: 20px;
}

.filter-group label {
display: block;
font-size: 13px;
color: #495057;
margin-bottom: 5px;
font-weight: 500;
}

.filter-group select,
.filter-group input[type="range"] {
width: 100%;
padding: 8px;
border: 1px solid #ced4da;
border-radius: 4px;
font-size: 14px;
background: white;
}

.filter-group input[type="range"] {
padding: 0;
}

.similarity-display {
text-align: center;
font-size: 13px;
color: #495057;
margin-top: 5px;
}

.filter-btn {
width: 100%;
padding: 10px;
background: #007BFF;
color: white;
border: none;
border-radius: 4px;
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: background 0.2s;
}

.filter-btn:hover {
background: #0056b3;
}

.clear-filters {
width: 100%;
padding: 8px;
background: white;
color: #6c757d;
border: 1px solid #ced4da;
border-radius: 4px;
font-size: 13px;
cursor: pointer;
margin-top: 10px;
transition: all 0.2s;
}

.clear-filters:hover {
background: #f8f9fa;
border-color: #adb5bd;
}

.remove-selected-btn {
width: 100%;
padding: 10px;
background: #dc3545;
color: white;
border: none;
border-radius: 4px;
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: background 0.2s;
margin-top: 10px;
}

.remove-selected-btn:hover {
background: #c82333;
}

.main-content {
flex: 1;
}

.faces-header {
background: white;
padding: 20px;
border-radius: 8px;
margin-bottom: 20px;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
display: flex;
justify-content: space-between;
align-items: center;
}

.header-info h1 {
font-size: 24px;
margin: 0 0 5px 0;
color: #212529;
}

.face-count {
font-size: 14px;
color: #6c757d;
}

.back-link {
color: #007BFF;
text-decoration: none;
font-size: 14px;
transition: color 0.2s;
}

.back-link:hover {
color: #0056b3;
text-decoration: underline;
}

.selection-controls {
display: flex;
gap: 15px;
align-items: center;
margin-bottom: 20px;
}

.selection-controls a {
color: #007BFF;
text-decoration: none;
font-size: 14px;
cursor: pointer;
}

.selection-controls a:hover {
text-decoration: underline;
}

.selection-controls .separator {
color: #dee2e6;
}

.faces-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
gap: 15px;
}

.face-card {
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
transition: all 0.2s;
cursor: pointer;
position: relative;
border: 3px solid transparent;
}

.face-card.selected {
border-color: #007BFF;
box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

.face-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.face-card img {
width: 100%;
height: 150px;
object-fit: cover;
display: block;
}

.face-info {
padding: 10px;
}

.face-date {
font-size: 12px;
color: #495057;
margin-bottom: 3px;
}

.face-similarity {
font-size: 11px;
color: #6c757d;
}

.similarity-high {
color: #28a745;
font-weight: 600;
}

.similarity-medium {
color: #ffc107;
font-weight: 600;
}

.similarity-low {
color: #dc3545;
font-weight: 600;
}

.empty-state {
text-align: center;
padding: 60px 20px;
background: white;
border-radius: 8px;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.empty-state h2 {
font-size: 20px;
color: #495057;
margin-bottom: 10px;
}

.empty-state p {
color: #6c757d;
font-size: 14px;
}

.tooltip {
position: absolute;
background: rgba(0, 0, 0, 0.9);
color: white;
padding: 8px 12px;
border-radius: 6px;
font-size: 12px;
pointer-events: none;
z-index: 1000;
white-space: nowrap;
opacity: 0;
transition: opacity 0.2s;
box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.tooltip.visible {
opacity: 1;
}

.tooltip::before {
content: '';
position: absolute;
bottom: -4px;
left: 50%;
transform: translateX(-50%);
width: 8px;
height: 8px;
background: rgba(0, 0, 0, 0.9);
transform: translateX(-50%) rotate(45deg);
}
{% endblock %}

{% block content %}
<div class="person-faces-layout">
    <div class="sidebar">
        <h2>Filters</h2>

        <form method="GET" action="{{ url_for('person_faces', person_id=person.id) }}" id="filter-form">
            <div class="filter-group">
                <label for="year-select">Year</label>
                <select name="year" id="year-select">
                    <option value="">All Years</option>
                    {% for year in filters.years %}
                    <option value="{{ year }}" {% if filters.selected_year== year %}selected{% endif %}>{{ year }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="month-select">Month</label>
                <select name="month" id="month-select">
                    <option value="">All Months</option>
                    {% for month in filters.months %}
                    <option value="{{ month.value }}" {% if filters.selected_month== month.value %}selected{% endif %}>
                        {{ month.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="similarity-range">Min Similarity</label>
                <input type="range" id="similarity-range" name="similarity" min="0" max="1" step="0.01"
                       value="{{ filters.selected_similarity or 0 }}">
                <div class="similarity-display"><span id="similarity-value">{{ ((filters.selected_similarity or 0) * 100)|int }}%</span>
                </div>
            </div>

            <div class="filter-group">
                <label for="face-page-size">Page Size</label>
                <select name="face-page-size" id="face-page-size">
                    {% for face_page_size in filters.face_page_sizes %}
                    <option value="{{ face_page_size }}" {% if filters.face_page_size== face_page_size %}selected{%
                            endif %}>{{ face_page_size }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="filter-btn">Apply Filters</button>
            <button type="button" class="clear-filters"
                    onclick="window.location.href='{{ url_for('person_faces', person_id=person.id) }}'">
                Clear Filters
            </button>
        </form>

        <h3>Actions</h3>
        <form method="POST" action="{{ url_for('person_faces_remove', person_id=person.id) }}" id="remove-form">
            <div id="selected-faces-container"></div>
            <button type="button" class="remove-selected-btn" onclick="removeSelectedFaces()">
                Remove Selected
            </button>
        </form>
    </div>

    <div class="main-content">
        <div class="faces-header">
            <div class="header-info">
                <h1>{{ person.name }}'s Faces</h1>
                <p class="face-count">
                    {% if faces|length > 0 %}
                    Showing {{ faces|length }} face{{ 's' if faces|length != 1 else '' }}
                    {% if filters.selected_year or filters.selected_month or filters.selected_similarity %}
                    (filtered)
                    {% endif %}
                    {% else %}
                    No faces found
                    {% endif %}
                </p>
            </div>
            <a href="{{ url_for('people_list') }}" class="back-link">‚Üê Back to People</a>
        </div>

        {% if faces|length > 0 %}
        <div class="selection-controls">
            <a href="#" id="select-all">Select all</a>
            <span class="separator">|</span>
            <a href="#" id="deselect-all">Clear selection</a>
        </div>

        <div class="faces-grid">
            {% for face_data in faces %}
            <div class="face-card"
                 data-face-id="{{ face_data.face.id }}"
                 data-similarity="{{ '%.2f' % (face_data.similarity * 100) if face_data.similarity is not none else 'N/A' }}"
                 data-date="{{ face_data.face.photo.date_taken.split(' ')[0] if face_data.face.photo.date_taken else 'Unknown' }}">
                <img src="{{ url_for('photo', filename=face_data.face.relative_file_path) }}" alt="Face">
                <div class="face-info">
                    <div class="face-date">{{ face_data.face.photo.date_taken.split(' ')[0] if
                        face_data.face.photo.date_taken else 'Unknown date' }}
                    </div>
                    <div class="face-similarity">
                        Similarity:
                        {% if face_data.similarity is not none %}
                        {% set sim_pct = (face_data.similarity * 100)|int %}
                        <span class="{% if sim_pct >= 95 %}similarity-high{% elif sim_pct >= 85 %}similarity-medium{% else %}similarity-low{% endif %}">
                                {{ sim_pct }}%
                            </span>
                        {% else %}
                        <span>N/A</span>
                        {% endif %}
                    </div>
                </div>
                <input type="checkbox" name="faces" value="{{ face_data.face.id }}" style="display:none;">
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h2>No faces found</h2>
            <p>{% if filters.selected_year or filters.selected_month or filters.selected_similarity %}
                Try adjusting your filters.
                {% else %}
                No faces have been assigned to {{ person.name }} yet.
                {% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    document.body.appendChild(tooltip);

    // Similarity slider update
    const similarityRange = document.getElementById('similarity-range');
    const similarityValue = document.getElementById('similarity-value');
    similarityRange.addEventListener('input', (e) => {
        similarityValue.textContent = Math.round(e.target.value * 100) + '%';
    });

    // Toggle selection on click
    document.querySelectorAll('.face-card').forEach(card => {
        card.addEventListener('click', () => {
            card.classList.toggle('selected');
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
        });

        // Tooltip on hover
        card.addEventListener('mouseenter', (e) => {
            const similarity = card.dataset.similarity;
            const date = card.dataset.date;
            tooltip.innerHTML = `Date: ${date}<br>Similarity: ${similarity}%`;
            tooltip.classList.add('visible');
        });

        card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            tooltip.style.left = rect.left + rect.width / 2 + 'px';
            tooltip.style.top = rect.top - 10 + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';
        });

        card.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
        });
    });

    // Select all / deselect all
    document.getElementById('select-all').addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.face-card').forEach(card => {
            card.classList.add('selected');
            card.querySelector('input[type="checkbox"]').checked = true;
        });
    });

    document.getElementById('deselect-all').addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.face-card').forEach(card => {
            card.classList.remove('selected');
            card.querySelector('input[type="checkbox"]').checked = false;
        });
    });

    // Remove selected faces
    function removeSelectedFaces() {
        const selectedCheckboxes = document.querySelectorAll('.face-card input[type="checkbox"]:checked');

        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one face to remove');
            return;
        }

        const container = document.getElementById('selected-faces-container');
        container.innerHTML = '';

        selectedCheckboxes.forEach(cb => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'faces';
            hidden.value = cb.value;
            container.appendChild(hidden);
        });

        document.getElementById('remove-form').submit();
    }
</script>
{% endblock %}