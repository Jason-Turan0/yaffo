{% extends "base.html" %}

{% block title %}{{ file_name }} - Photo Organizer{% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='photos/view.css') }}">
{% endblock %}

{% from "components/collapsible_panel.html" import collapsible_panel %}

{% block content %}
<div class="photo-viewer">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Photo Details</h2>
        </div>

        <div class="sidebar-content">
            <div class="detail-section">
                <h3>File Information</h3>
                <div class="detail-item">
                    <label>Name:</label>
                    <span class="detail-value">{{ file_name }}</span>
                </div>
                <div class="detail-item">
                    <label>Folder:</label>
                    <span class="detail-value">{{ absolute_folder_path if absolute_folder_path else '/' }}</span>
                </div>
                {% if photo.date_taken %}
                <div class="detail-item">
                    <label>Date Taken:</label>
                    <span class="detail-value">{{ photo.date_taken }}</span>
                </div>
                {% endif %}
                <div class="detail-actions">
                    <button onclick="window.PHOTO_ORGANIZER.photoView.openFile('{{ absolute_file_path }}')" class="action-button">
                        Open File
                    </button>
                    <button onclick="window.PHOTO_ORGANIZER.photoView.openFolder('{{ absolute_folder_path }}')" class="action-button">
                        Open Folder
                    </button>
                </div>
            </div>

            <div class="detail-section">
                <h3>Location</h3>
                {% if photo.location_name or photo.latitude or photo.longitude %}
                <div class="location-details">
                    {% if photo.location_name %}
                    <div class="detail-item">
                        <label>Name:</label>
                        <span class="detail-value">{{ photo.location_name }}</span>
                    </div>
                    {% endif %}
                    {% if photo.latitude and photo.longitude %}
                    <div class="detail-item">
                        <label>Coordinates:</label>
                        <span class="detail-value">
                            {{ "%.6f"|format(photo.latitude) }}, {{ "%.6f"|format(photo.longitude) }}
                        </span>
                    </div>
                    <div class="detail-actions">
                        <a href="https://www.google.com/maps?q={{ photo.latitude }},{{ photo.longitude }}"
                           target="_blank"
                           class="action-button">
                            View on Map
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="no-data">No location information</p>
                {% endif %}
            </div>

            <div class="detail-section">
                <h3>People ({{ people|length }})</h3>
                {% if people %}
                <div class="people-list">
                    {% for person in people %}
                    <a href="{{ url_for('person_faces', person_id=person.id) }}" class="person-tag">
                        {{ person.name }}
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="no-data">No people assigned to this photo</p>
                {% endif %}
            </div>

            <div class="detail-section">
                <h3>Faces ({{ photo.faces|length }})</h3>
                {% if photo.faces %}
                <div class="faces-grid">
                    {% for face in photo.faces %}
                    <div class="face-thumbnail"
                         data-face-id="{{ face.id }}"
                         onmouseenter="window.PHOTO_ORGANIZER.photoView.highlightFace({{ face.id }})"
                         onmouseleave="window.PHOTO_ORGANIZER.photoView.clearHighlights()">
                        <img src="{{ url_for('photo', filename=face.relative_file_path) }}" alt="Face">
                        {% if face.people %}
                        <div class="face-label">
                            {% for person in face.people %}
                            {{ person.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="no-data">No faces detected</p>
                {% endif %}
            </div>

            {% call collapsible_panel('tags-panel', 'Tags (' ~ photo.tags|length ~ ')', is_open=False) %}
                <div id="tags-container">
                    {% if photo.tags %}
                        <div class="tags-list-editable">
                            {% for tag in photo.tags %}
                            <div class="tag-item-editable" data-tag-id="{{ tag.id }}">
                                <div class="tag-display">
                                    <span class="tag-name">{{ tag.tag_name }}</span>
                                    {% if tag.tag_value %}
                                    <span class="tag-separator">:</span>
                                    <span class="tag-value">{{ tag.tag_value }}</span>
                                    {% endif %}
                                </div>
                                <div class="tag-actions">
                                    <button type="button" class="tag-action-btn edit-tag-btn" onclick="window.PHOTO_ORGANIZER.photoTags.editTag({{ tag.id }}, '{{ tag.tag_name }}', '{{ tag.tag_value if tag.tag_value else '' }}')" title="Edit">
                                        ‚úèÔ∏è
                                    </button>
                                    <button type="button" class="tag-action-btn delete-tag-btn" onclick="window.PHOTO_ORGANIZER.photoTags.deleteTag({{ tag.id }})" title="Delete">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="no-data">No tags</p>
                    {% endif %}
                </div>

                <div class="tag-add-form" id="tag-add-form">
                    <h4 style="margin: 15px 0 10px 0; font-size: 12px; color: #6c757d; text-transform: uppercase;">Add New Tag</h4>
                    <div class="form-row">
                        <input type="text" id="new-tag-name" placeholder="Tag name" class="tag-input">
                        <input type="text" id="new-tag-value" placeholder="Tag value (optional)" class="tag-input">
                    </div>
                    <button type="button" class="btn-primary" onclick="window.PHOTO_ORGANIZER.photoTags.addTag()" style="width: 100%; margin-top: 10px;">Add Tag</button>
                </div>
            {% endcall %}
        </div>
    </div>

    <div class="photo-container">
        <div class="photo-wrapper">
            <div class="photo-image-container">
                <img src="{{ url_for('photo', filename=photo.relative_file_path) }}"
                     alt="{{ file_name }}"
                     class="photo-main"
                     id="mainPhoto">
                <canvas id="faceCanvas" class="face-overlay"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='components/collapsible_panel.js') }}"></script>
<script src="{{ url_for('static', filename='photos/view.js') }}"></script>
<script src="{{ url_for('static', filename='photos/tags.js') }}"></script>
<script>
// Initialize photo view modules
window.PHOTO_ORGANIZER.photoView = window.PHOTO_ORGANIZER.initPhotoView(
    {{ faces_with_locations | tojson }},
    '{{ absolute_file_path }}',
    '{{ absolute_folder_path }}',
    window.APP_CONFIG
);

window.PHOTO_ORGANIZER.photoTags = window.PHOTO_ORGANIZER.initPhotoTags(
    {{ photo.id }},
    window.APP_CONFIG
);
</script>
{% endblock %}