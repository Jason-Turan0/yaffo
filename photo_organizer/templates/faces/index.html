<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Organize Faces</title>
<style>
.grid { display: grid; grid-template-columns: repeat(auto-fill, 100px); gap: 10px; }
.face { border: 2px solid transparent; cursor: pointer; }
.face.selected { border-color: #007BFF; }
</style>
</head>
<body>
<h1>Unassigned Faces</h1>

<form method="POST" action="{{ url_for('faces_assign') }}" >
     <input type="hidden" name="face_status" id="face_status" value="">
     <div class="buttons">
        <button type="button" id="select-all">Select All</button>
        <button type="button" id="deselect-all">Deselect All</button>
         <select name="person">
            <option value="">-- Assign to person --</option>
            {% for person in people %}
            <option value="{{ person.id }}">{{ person.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="assign-btn">Assign Selected</button>
        <button type="submit" class="ignore-btn">Ignore Selected</button>
    </div>
    {% for faceSuggestion in face_suggestions %}
    <div class="suggestion-group" >
            <h2>{{ faceSuggestion.suggestion_name }}</h2>
          <button type="button" class="select-group">Select All</button>
          <button type="button" class="deselect-group">Deselect All</button>
        {% for person in faceSuggestion.people %}
          <button  class="assign-group-btn" data-person-id="{{person.id}}">Assign Selected to {{person.name}}</button>
        {% endfor %}
        <button type="submit" class="ignore-btn">Ignore Selected</button>
    <div class="grid">
            {% for face in faceSuggestion.faces %}


                    <div class="face" data-face-id="{{ face.id }}" title="Simularity {{  '%.2f' % (face.similarity * 100) if face.similarity is not none else 'N/A'  }}%. Date Taken {{ face.photo_date.split(' ')[0] }}" >
                        <img src="{{ url_for('photo', filename=face.relative_file_path) }}" width="100" height="100">
                        <input type="checkbox" name="faces" value="{{ face.id }}" style="display:none;">
                    </div>
            {% endfor %}
    </div>
        </div>
    {% endfor %}
</form>

<script>
// Toggle selection on click
document.querySelectorAll('.face').forEach(div => {
    div.addEventListener('click', () => {
        div.classList.toggle('selected');
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
    });
});

// Select all / deselect all buttons
document.getElementById('select-all').addEventListener('click', () => {
    document.querySelectorAll('.face').forEach(div => {
        div.classList.add('selected');
        div.querySelector('input[type="checkbox"]').checked = true;
    });
});

document.getElementById('deselect-all').addEventListener('click', () => {
    document.querySelectorAll('.face').forEach(div => {
        div.classList.remove('selected');
        div.querySelector('input[type="checkbox"]').checked = false;
    });
});

// Group-level select/deselect
document.querySelectorAll('.suggestion-group').forEach(group => {
    group.querySelector('.select-group').addEventListener('click', () => {
        group.querySelectorAll('.face').forEach(f => {
            f.classList.add('selected');
            f.querySelector('input[type="checkbox"]').checked = true;
        });
    });
    group.querySelector('.deselect-group').addEventListener('click', () => {
        group.querySelectorAll('.face').forEach(f => {
            f.classList.remove('selected');
            f.querySelector('input[type="checkbox"]').checked = false;
        });
    });
});

const form = document.querySelector('form');
const faceStatusInput = document.getElementById('face_status');
const personSelect = form.querySelector('select[name="person"]');


// Set value before submitting
document.querySelector('.assign-btn').addEventListener('click', () => {
    faceStatusInput.value = 'ASSIGNED';
});

document.querySelector('.ignore-btn').addEventListener('click', () => {
    faceStatusInput.value = 'IGNORED';
});

document.querySelectorAll('.assign-group-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const personId = btn.dataset.personId;
        faceStatusInput.value = 'ASSIGNED';
        personSelect.value = personId;
        form.submit();
    });
});


</script>

</body>
</html>
