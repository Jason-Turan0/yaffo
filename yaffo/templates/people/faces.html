{% extends "base.html" %}

{% block title %}{{ person.name }}'s Faces - Photo Organizer{% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='people/faces.css') }}">
{% endblock %}
{% from "_sidebar.html" import render_sidebar %}
{% from "filters/_similarity.html" import similarity_filter %}
{% from "components/pagination.html" import pagination as render_pagination %}


{% block content %}
    <div class="main-container-layout">
        {% macro render_filters() %}
            {{ similarity_filter('min_similarity', 'Min Similarity', filters) }}
            {{ similarity_filter('max_similarity', 'Max Similarity', filters) }}
        {% endmacro %}
        {% macro render_actions() %}
            <form method="POST" action="{{ url_for('person_faces_remove', person_id=person.id) }}" id="remove-form">
                <div id="selected-faces-container"></div>
                <button type="button" class="remove-selected-btn" onclick="removeSelectedFaces()">
                    Remove Selected
                </button>
            </form>
        {% endmacro %}

        {{ render_sidebar(url_for('person_faces', person_id=person.id), filters, render_filters, render_actions) }}
        <div class="main-content">
            <div class="page-header">
                <div class="header-info">
                    <h1>{{ person.name }}'s Faces</h1>
                    <p class="face-count">
                        {% if faces|length > 0 %}
                            Showing {{ faces|length }} face{{ 's' if faces|length != 1 else '' }}
                            {% if filters.selected_year or filters.selected_month or filters.min_similarity or filters.max_similarity %}
                                (filtered)
                            {% endif %}
                        {% else %}
                            No faces found
                        {% endif %}
                    </p>
                </div>
                <a href="{{ url_for('people_list') }}" class="action-link">‚Üê Back to People</a>
            </div>

            {% if faces|length > 0 %}
                <div class="selection-controls">
                    <a href="#" id="select-all" class="action-link">Select all</a>
                    <span class="separator">|</span>
                    <a href="#" id="deselect-all" class="action-link">Clear selection</a>
                </div>

                <div class="faces-grid">
                    {% for face_data in faces %}
                        <div class="face-card"
                             data-face-id="{{ face_data.face.id }}"
                             data-similarity="{{ '%.2f' % (face_data.similarity * 100) if face_data.similarity is not none else 'N/A' }}"
                             data-date="{{ face_data.face.photo.date_taken }}">
                            <img src="{{ url_for('face_thumbnail', face_id=face_data.face.id) }}" alt="Face">
                            <div class="face-info">
                                <div class="face-date">{{ face_data.face.photo.date_taken | format_date("date") if face_data.face.photo.date_taken else 'Unknown date' }}
                                </div>
                                <div class="face-similarity">
                                    Similarity:
                                    {% if face_data.similarity is not none %}
                                        {% set sim_pct = (face_data.similarity * 100)|int %}
                                        <span class="{% if sim_pct >= 95 %}similarity-high{% elif sim_pct >= 85 %}similarity-medium{% else %}similarity-low{% endif %}">
                                {{ sim_pct }}%
                            </span>
                                    {% else %}
                                        <span>N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                            <input type="checkbox" name="faces" value="{{ face_data.face.id }}" style="display:none;">
                        </div>
                    {% endfor %}
                </div>

                {{ render_pagination(
            pagination.current_page,
            pagination.total_items,
            pagination.page_size,
            pagination.page_sizes,
            url_for('person_faces', person_id=person.id),
            {
                'year': filters.selected_year,
                'month': filters.selected_month,
                'min_similarity': filters.min_similarity,
                'max_similarity': filters.max_similarity
            }
        ) }}
            {% else %}
                <div class="empty-state">
                    <h2>No faces found</h2>
                    <p>{% if filters.selected_year or filters.selected_month or filters.selected_similarity %}
                        Try adjusting your filters.
                    {% else %}
                        No faces have been assigned to {{ person.name }} yet.
                    {% endif %}</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='people/faces.js') }}"></script>
{% endblock %}